<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AirGuard - ITNL</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #0088CC; --success: #10B981; --warning: #F59E0B;
            --danger: #EF4444; --bg: #F8F9FA; --card: #FFF;
            --text: #1F2937; --text-light: #6B7280; --border: #E5E7EB;
            --platinum: #5e5e5e; --platinum-light: #858585;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--text);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Login */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; }
        .login-box { background: white; border-radius: 16px; padding: 2rem; width: 100%; max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-logo { text-align: center; font-size: 4rem; margin-bottom: 1rem; }
        .login-title { text-align: center; font-size: 1.8rem; margin-bottom: 0.5rem; font-weight: 700; }
        .login-subtitle { text-align: center; color: var(--text-light); margin-bottom: 2rem; font-size: 0.9rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-input { width: 100%; padding: 0.875rem; border: 2px solid var(--border);
            border-radius: 8px; font-size: 1rem; }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .btn-login { width: 100%; padding: 1rem; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .message { padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .message.show { display: block; }
        .message.error { background: #FEE2E2; color: #991B1B; }
        .message.success { background: #D1FAE5; color: #065F46; }
        
        /* App */
        .app-container { display: none; }
        .app-container.active { display: block; }
        
        /* Offline Message */
        .offline-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            text-align: center;
            padding: 2rem;
        }
        .offline-screen.show {
            display: flex;
        }
        .offline-icon {
            font-size: 5rem;
            margin-bottom: 2rem;
        }
        .offline-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .offline-message {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 400px;
            line-height: 1.6;
            margin-bottom: 2rem;
        }
        .offline-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .header { background: linear-gradient(135deg, var(--platinum) 0%, var(--platinum-light) 100%);
            color: white; padding: 1rem; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .header-content { display: flex; justify-content: space-between; align-items: center; 
            max-width: 1200px; margin: 0 auto; }
        .app-title { font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
        .app-logo { font-size: 1.8rem; }
        .btn-header { background: rgba(255,255,255,0.2); border: none; color: white;
            padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;
            transition: all 0.3s; font-size: 0.85rem; }
        .btn-header:hover { background: rgba(255,255,255,0.3); }
        .header-buttons { display: flex; gap: 0.5rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; padding-bottom: 90px; }
        
        /* Banner */
        .banner { padding: 1rem; border-radius: 12px; margin-bottom: 1rem; display: flex;
            align-items: center; gap: 1rem; font-weight: 600; }
        .banner.connected { background: #D1FAE5; color: #065F46; border: 2px solid var(--success); }
        .banner.disconnected { background: #FEE2E2; color: #991B1B; border: 2px solid var(--danger); }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.connected { background: var(--success); animation: pulse 2s infinite; }
        .dot.disconnected { background: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Bottom Navigation */
        .tabs { 
            display: flex; 
            justify-content: space-around;
            align-items: center;
            gap: 0;
            padding: 0.5rem 0;
            background: white;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.15);
            border-top: 2px solid var(--platinum);
        }
        .tab { 
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.7rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateZ(0);
            color: var(--text-light);
            gap: 0.25rem;
        }
        .tab-icon {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        .tab.active { 
            color: var(--platinum);
            font-weight: 700;
        }
        .tab.active .tab-icon {
            transform: scale(1.2);
        }
        .tab:active {
            transform: scale(0.95);
        }
        .tab-content { 
            display: none;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-content.active { 
            display: block;
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Card */
        .card { background: white; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;
            color: var(--platinum); }
        
        /* Gauge Grid */
        .gauge-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 1rem;
            justify-items: center;
            max-width: 100%;
            margin: 0 auto;
        }
        .gauge-container { 
            background: linear-gradient(145deg, #ffffff 0%, #f5f5f5 100%);
            border: 3px solid var(--platinum); 
            border-radius: 16px; 
            padding: 1rem;
            text-align: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 180px;
        }
        .gauge-name { font-weight: 700; color: var(--platinum); margin-bottom: 0.5rem;
            font-size: 0.95rem; letter-spacing: 0.5px; }
        .gauge-canvas { margin: 0.5rem auto; image-rendering: -webkit-optimize-contrast; 
            image-rendering: crisp-edges; }
        .gauge-value { font-size: 1.5rem; font-weight: 700; color: var(--platinum);
            margin: 0.5rem 0; }
        .gauge-unit { font-size: 0.85rem; color: var(--platinum-light); font-weight: 600; }
        .badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 12px;
            font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem; }
        .badge.good { background: #D1FAE5; color: #065F46; }
        .badge.moderate { background: #FEF3C7; color: #92400E; }
        .badge.unhealthy { background: #FEE2E2; color: #991B1B; }
        .gauge-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 0.5rem;
            font-size: 0.65rem;
            color: var(--platinum-light);
            font-weight: 600;
        }
        .gauge-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .gauge-stat-label {
            font-size: 0.6rem;
            opacity: 0.7;
        }
        .gauge-stat-value {
            font-weight: 700;
            color: var(--platinum);
        }
        
        /* Filters */
        .filters { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;
            border: 2px solid var(--platinum); }
        .filter-title { font-weight: 700; color: var(--platinum); margin-bottom: 1rem; }
        .filter-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem; margin-bottom: 1rem; }
        .filter-btn { padding: 0.75rem; border: 2px solid var(--border); background: white;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;
            font-size: 0.85rem; }
        .filter-btn.active { background: var(--platinum); color: white; border-color: var(--platinum); }
        .filter-btn:hover { border-color: var(--platinum); }
        .filter-btn:active { transform: scale(0.95); }
        .custom-range { display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem;
            align-items: center; }
        .date-input { padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px;
            font-size: 0.9rem; }
        
        /* Table */
        .table-container { overflow-x: auto; border-radius: 12px; border: 2px solid var(--platinum); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        thead { background: linear-gradient(135deg, var(--platinum) 0%, var(--platinum-light) 100%); 
            color: white; }
        th, td { padding: 0.875rem; text-align: left; font-size: 0.85rem; }
        tbody tr:nth-child(even) { background: #FAFAFA; }
        tbody tr:hover { background: #F0F0F0; }
        .records-info { padding: 0.75rem; background: #F0F0F0; border-radius: 8px;
            margin-bottom: 1rem; text-align: center; font-weight: 600; color: var(--platinum); }
        
        /* Buttons */
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.9rem; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-platinum { background: var(--platinum); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 16px; padding: 2rem; max-width: 400px;
            width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem;
            color: var(--platinum); }
        
        /* Chart */
        .chart-wrapper { 
            margin-bottom: 1rem; 
            padding: 1rem;
        }
        .chart-controls { 
            display: flex; 
            gap: 0.5rem; 
            margin-bottom: 1rem; 
            flex-wrap: wrap;
            justify-content: center;
        }
        .chart-btn { 
            padding: 0.75rem 1.25rem; 
            border: 2px solid var(--border); 
            background: white;
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chart-btn.active { 
            background: var(--platinum); 
            color: white; 
            border-color: var(--platinum);
            transform: scale(1.05);
        }
        .chart-btn:active {
            transform: scale(0.95);
        }
        .chart-title { 
            font-weight: 700; 
            color: var(--platinum); 
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        canvas { 
            max-height: 350px; 
            width: 100% !important;
            height: 300px !important;
        }
        
        /* Notification */
        .notification { position: fixed; top: 80px; right: 20px; background: white;
            border-left: 4px solid var(--danger); border-radius: 8px; padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 300px; display: none;
            z-index: 1000; animation: slideIn 0.3s; }
        .notification.show { display: block; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .notif-title { font-weight: 700; margin-bottom: 0.5rem; }
        
        /* Loading */
        .loading { text-align: center; padding: 2rem; color: var(--text-light); }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--platinum);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
            margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Predictions */
        .prediction-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .prediction-title {
            font-weight: 700;
            color: var(--platinum);
            font-size: 1.1rem;
        }
        .prediction-subtitle {
            color: var(--text-light);
            font-size: 0.85rem;
        }
        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }
        .prediction-day {
            background: #F9FAFB;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--border);
        }
        .prediction-day-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        .prediction-day-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--platinum);
        }
        .prediction-day-unit {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        @media (max-width: 768px) {
            .gauge-grid { 
                grid-template-columns: repeat(2, 1fr);
                padding: 0 0.5rem;
            }
            .gauge-container {
                max-width: 100%;
            }
            .filter-buttons { grid-template-columns: repeat(2, 1fr); }
            .custom-range { grid-template-columns: 1fr; }
            .chart-controls { justify-content: center; }
            canvas { max-height: 250px !important; height: 250px !important; }
            .tab {
                font-size: 0.65rem;
                padding: 0.4rem;
            }
            .tab-icon {
                font-size: 1.3rem;
            }
            .header-buttons { gap: 0.25rem; }
            .btn-header { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
        }
        
        @media (max-width: 360px) {
            .gauge-grid {
                grid-template-columns: 1fr;
                max-width: 280px;
                margin: 0 auto;
            }
            .tab {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- Offline Message -->
    <div id="offlineScreen" class="offline-screen">
        <div class="offline-icon">üì°</div>
        <div class="offline-title">Sin Conexi√≥n</div>
        <div class="offline-message">
            Para acceder a AirGuard necesitas estar conectado a internet.<br>
            Por favor verifica tu conexi√≥n y vuelve a intentar.
        </div>
        <button class="offline-btn" onclick="location.reload()">üîÑ Reintentar</button>
    </div>

    <!-- Login -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-logo">üì°</div>
            <div class="login-title">AirGuard</div>
            <div class="login-subtitle">Sistema de Monitoreo Ambiental - ITNL</div>
            <div id="loginError" class="message error"></div>
            <div id="loginSuccess" class="message success"></div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="email" id="email" class="form-input" placeholder="Email" 
                           value="admin@monitoreo.com" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" class="form-input" placeholder="Contrase√±a" 
                           value="Monitoreo#2025" required>
                </div>
                <button type="submit" class="btn-login">Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <!-- App -->
    <div id="appContainer" class="app-container">
        <div id="notification" class="notification">
            <div class="notif-title">‚ö†Ô∏è Alerta</div>
            <div id="notifText"></div>
        </div>

        <div class="header">
            <div class="header-content">
                <div class="app-title">
                    <span class="app-logo">üì°</span>
                    <span>AirGuard</span>
                </div>
                <div class="header-buttons">
                    <button class="btn-header" onclick="refreshData()">üîÑ</button>
                    <button class="btn-header" onclick="generateReport()">üìÑ Reporte</button>
                    <button class="btn-header" onclick="logout()">üö™</button>
                </div>
            </div>
        </div>

        <div class="container">
            <div id="banner" class="banner disconnected">
                <div class="dot disconnected"></div>
                <span id="bannerText">Conectando...</span>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <div class="card-header">‚ö° Variables Cr√≠ticas</div>
                    <div class="gauge-grid" id="dashboardGauges"></div>
                </div>
            </div>

            <!-- Historial -->
            <div id="historial" class="tab-content">
                <div class="card">
                    <div class="card-header">üìú Historial Completo</div>
                    
                    <div class="filters">
                        <div class="filter-title">üîç Filtrar por Tiempo</div>
                        <div class="filter-buttons">
                            <button class="filter-btn" onclick="filterTime('first50')">Primeros 50</button>
                            <button class="filter-btn active" onclick="filterTime('all')">Todo</button>
                            <button class="filter-btn" onclick="filterTime('today')">Hoy</button>
                            <button class="filter-btn" onclick="filterTime('yesterday')">Ayer</button>
                            <button class="filter-btn" onclick="filterTime('week')">7 d√≠as</button>
                            <button class="filter-btn" onclick="filterTime('month')">30 d√≠as</button>
                        </div>
                        <div class="custom-range">
                            <input type="date" id="dateFrom" class="date-input">
                            <input type="date" id="dateTo" class="date-input">
                            <button class="btn btn-platinum" onclick="filterCustomRange()">Aplicar</button>
                        </div>
                    </div>

                    <div class="records-info">
                        üìä Mostrando <span id="recordCount">0</span> de <span id="totalCount">0</span> registros
                    </div>

                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="exportExcel()">üìä Excel</button>
                        <button class="btn btn-primary" onclick="exportCSV()">üìÑ CSV</button>
                        <button class="btn btn-danger" onclick="showDeleteMenu()">üóëÔ∏è Borrar</button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th><th>CO</th><th>CO2</th>
                                    <th>PM1.0</th><th>PM2.5</th><th>PM10</th>
                                    <th>Temp</th><th>Presi√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficas -->
            <div id="graficas" class="tab-content">
                <div class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, var(--platinum) 0%, var(--platinum-light) 100%);">
                    <div style="color: white; font-weight: 700; margin-bottom: 1rem;">
                        ‚è±Ô∏è Rango de Tiempo para Gr√°ficas
                    </div>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="setChartRange('last7')" style="background: white; color: var(--platinum);">
                            √öltimas 7
                        </button>
                        <button class="chart-btn" onclick="setChartRange('last10')" style="background: white; color: var(--platinum);">
                            √öltimas 10
                        </button>
                        <button class="chart-btn active" onclick="setChartRange('last50')" style="background: white; color: var(--platinum);">
                            √öltimas 50
                        </button>
                        <button class="chart-btn" onclick="setChartRange('last100')" style="background: white; color: var(--platinum);">
                            √öltimas 100
                        </button>
                        <button class="chart-btn" onclick="setChartRange('hour')" style="background: white; color: var(--platinum);">
                            √öltima Hora
                        </button>
                        <button class="chart-btn" onclick="setChartRange('day')" style="background: white; color: var(--platinum);">
                            Hoy
                        </button>
                        <button class="chart-btn" onclick="setChartRange('week')" style="background: white; color: var(--platinum);">
                            7 D√≠as
                        </button>
                    </div>
                    <div class="custom-range" style="margin-top: 1rem;">
                        <input type="date" id="chartDateFrom" class="date-input" style="background: white;">
                        <input type="date" id="chartDateTo" class="date-input" style="background: white;">
                        <button class="btn btn-primary" onclick="filterChartCustomRange()">Aplicar</button>
                    </div>
                    <div style="color: white; font-size: 0.85rem; margin-top: 0.5rem; text-align: center;">
                        üìä Mostrando <span id="chartDataCount">0</span> lecturas
                    </div>
                </div>

                <div id="chartsContainer"></div>
            </div>

            <!-- Predicci√≥n -->
            <div id="prediccion" class="tab-content">
                <div class="card">
                    <div class="card-header">üìä Predicciones Estad√≠sticas - Pr√≥ximos 7 D√≠as</div>
                    
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <button class="btn btn-platinum" onclick="loadPredictions()" style="padding: 1rem 2rem; font-size: 1.1rem;">
                            üìà Generar Predicciones
                        </button>
                    </div>

                    <div id="predictionsLoading" style="display: none;" class="loading">
                        <div class="spinner"></div>
                        <p>Analizando datos y generando predicciones...</p>
                    </div>

                    <div id="predictionsContainer"></div>
                </div>
            </div>

            <div style="text-align: center; color: var(--text-light); font-size: 0.85rem; margin-top: 1rem;">
                üïê √öltima actualizaci√≥n: <span id="lastUpdate">--</span>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">
                <div class="tab-icon">‚ö°</div>
                <div>Dashboard</div>
            </button>
            <button class="tab" onclick="switchTab('historial')">
                <div class="tab-icon">üìú</div>
                <div>Historial</div>
            </button>
            <button class="tab" onclick="switchTab('graficas')">
                <div class="tab-icon">üìà</div>
                <div>Gr√°ficas</div>
            </button>
            <button class="tab" onclick="switchTab('prediccion')">
                <div class="tab-icon">üìê</div>
                <div>An√°lisis</div>
            </button>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">üóëÔ∏è Opciones de Borrado</div>
                <button class="btn btn-danger" onclick="deleteRecent(50)" style="width: 100%; margin-bottom: 0.75rem;">
                    Borrar √∫ltimas 50
                </button>
                <button class="btn btn-danger" onclick="deleteRecent(100)" style="width: 100%; margin-bottom: 0.75rem;">
                    Borrar √∫ltimas 100
                </button>
                <button class="btn btn-danger" onclick="deleteRecent(500)" style="width: 100%; margin-bottom: 0.75rem;">
                    Borrar √∫ltimas 500
                </button>
                <button class="btn btn-danger" onclick="deleteAll()" style="width: 100%; margin-bottom: 1rem;">
                    üö® Borrar TODO
                </button>
                <button class="btn btn-primary" onclick="closeDeleteMenu()" style="width: 100%;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDXf14TEST2aoTbiA-ciF2Dm9_oYCddp3g",
            authDomain: "app-monitoreo-itnl-v0.firebaseapp.com",
            databaseURL: "https://app-monitoreo-itnl-v0-default-rtdb.firebaseio.com",
            projectId: "app-monitoreo-itnl-v0",
            storageBucket: "app-monitoreo-itnl-v0.firebasestorage.app",
            messagingSenderId: "488643441374",
            appId: "1:488643441374:web:d4cced988c096d31e8884f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let allData = [];
        let filteredData = [];
        let charts = {};
        let gauges = {};
        let chartRange = 'last50';

        // 7 variables principales del dashboard
        const DASHBOARD_VARS = [
            {id: 'CO', name: 'CO', unit: 'ppm', max: 100},
            {id: 'CO2', name: 'CO2', unit: 'ppm', max: 5000},
            {id: 'PM1', name: 'PM1.0', unit: '¬µg/m¬≥', max: 100},
            {id: 'PM25', name: 'PM2.5', unit: '¬µg/m¬≥', max: 150},
            {id: 'PM10', name: 'PM10', unit: '¬µg/m¬≥', max: 350},
            {id: 'Temp', name: 'TEMP', unit: '¬∞C', max: 50},
            {id: 'Pressure', name: 'PRESI√ìN', unit: 'Pa', max: 1050}
        ];

        const THRESHOLDS = {
            CO: {good: 9, moderate: 35, critical: 50, max: 100},
            CO2: {good: 1000, moderate: 2000, critical: 5000, max: 5000},
            PM1: {good: 10, moderate: 25, critical: 50, max: 100},
            PM25: {good: 12, moderate: 35.4, critical: 55.4, max: 150},
            PM10: {good: 54, moderate: 154, critical: 254, max: 350},
            Temp: {good: 25, moderate: 30, critical: 35, max: 50},
            Pressure: {good: 1013, moderate: 1020, critical: 1030, max: 1050}
        };

        const gaugeStats = {};
        DASHBOARD_VARS.forEach(v => {
            gaugeStats[v.id] = {min: Infinity, max: -Infinity};
        });

        // Detector de conexi√≥n
        window.addEventListener('online', () => {
            document.getElementById('offlineScreen').classList.remove('show');
        });
        window.addEventListener('offline', () => {
            document.getElementById('offlineScreen').classList.add('show');
        });

        // Login - MANTENER EL ORIGINAL QUE FUNCIONA
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = e.target.querySelector('.btn-login');

            btn.disabled = true;
            btn.textContent = 'Iniciando...';

            try {
                const cred = await auth.signInWithEmailAndPassword(email, password);
                currentUser = cred.user;
                console.log('‚úÖ Login OK');

                document.getElementById('loginSuccess').textContent = '¬°Bienvenido!';
                document.getElementById('loginSuccess').classList.add('show');

                setTimeout(() => {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('appContainer').classList.add('active');
                    initApp();
                }, 1000);
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
                document.getElementById('loginError').classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Iniciar Sesi√≥n';
            }
        });

        function logout() {
            auth.signOut();
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('loginContainer').style.display = 'flex';
        }

        function initApp() {
            console.log('üöÄ Iniciando AirGuard...');
            createDashboardGauges();
            createCharts();
            setupFirebase();
            updateBanner('connected', 'Conectado - Tiempo real');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
            document.getElementById('chartDateFrom').value = today;
            document.getElementById('chartDateTo').value = today;
            
            // Actualizar cada 10 segundos
            setInterval(checkForUpdates, 10000);
        }

        function createDashboardGauges() {
            const container = document.getElementById('dashboardGauges');
            container.innerHTML = DASHBOARD_VARS.map(v => `
                <div class="gauge-container">
                    <div class="gauge-name">${v.name}</div>
                    <canvas id="gauge${v.id}" class="gauge-canvas" width="140" height="140"></canvas>
                    <div class="gauge-value" id="val${v.id}">--</div>
                    <div class="gauge-unit">${v.unit}</div>
                    <div class="badge good" id="stat${v.id}">Sin datos</div>
                    <div class="gauge-stats">
                        <div class="gauge-stat">
                            <div class="gauge-stat-label">M√≠n</div>
                            <div class="gauge-stat-value" id="min${v.id}">--</div>
                        </div>
                        <div class="gauge-stat">
                            <div class="gauge-stat-label">M√°x</div>
                            <div class="gauge-stat-value" id="max${v.id}">--</div>
                        </div>
                    </div>
                </div>
            `).join('');

            DASHBOARD_VARS.forEach(v => {
                const canvas = document.getElementById('gauge' + v.id);
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                gauges[v.id] = { canvas, ctx, value: 0 };
                drawGauge(v.id, 0);
            });
        }

        function drawGauge(id, value) {
            const gauge = gauges[id];
            const ctx = gauge.ctx;
            const canvas = gauge.canvas;
            
            const w = canvas.width;
            const h = canvas.height;
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            
            const cx = w / 2;
            const cy = h / 2;
            const radius = Math.min(w, h) / 2 - 12;

            ctx.clearRect(0, 0, w, h);

            // Background arc
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0.75 * Math.PI, 2.25 * Math.PI);
            ctx.lineWidth = 14;
            ctx.strokeStyle = '#E5E7EB';
            ctx.stroke();

            const threshold = THRESHOLDS[id];
            const percent = Math.min(value / threshold.max, 1);
            const endAngle = 0.75 * Math.PI + percent * 1.5 * Math.PI;

            // Value arc with gradient
            const gradient = ctx.createLinearGradient(0, 0, w, 0);
            if (value <= threshold.good) {
                gradient.addColorStop(0, '#10B981');
                gradient.addColorStop(1, '#34D399');
            } else if (value <= threshold.moderate) {
                gradient.addColorStop(0, '#F59E0B');
                gradient.addColorStop(1, '#FBBF24');
            } else {
                gradient.addColorStop(0, '#EF4444');
                gradient.addColorStop(1, '#F87171');
            }

            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0.75 * Math.PI, endAngle);
            ctx.lineWidth = 14;
            ctx.strokeStyle = gradient;
            ctx.lineCap = 'round';
            ctx.stroke();

            // Center circle
            ctx.beginPath();
            ctx.arc(cx, cy, radius - 24, 0, 2 * Math.PI);
            const centerGradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius - 24);
            centerGradient.addColorStop(0, '#858585');
            centerGradient.addColorStop(1, '#5e5e5e');
            ctx.fillStyle = centerGradient;
            ctx.fill();

            // Needle
            const needleLength = radius - 28;
            const needleAngle = 0.75 * Math.PI + percent * 1.5 * Math.PI;
            const needleX = cx + Math.cos(needleAngle) * needleLength;
            const needleY = cy + Math.sin(needleAngle) * needleLength;

            // Needle shadow
            ctx.beginPath();
            ctx.moveTo(cx + 2, cy + 2);
            ctx.lineTo(needleX + 2, needleY + 2);
            ctx.lineWidth = 4;
            ctx.strokeStyle = 'rgba(0,0,0,0.3)';
            ctx.lineCap = 'round';
            ctx.stroke();

            // Needle
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(needleX, needleY);
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#ffffff';
            ctx.lineCap = 'round';
            ctx.stroke();

            // Center bolt
            ctx.beginPath();
            ctx.arc(cx, cy, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            ctx.strokeStyle = '#5e5e5e';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function updateGauge(id, value) {
            drawGauge(id, value);
            updateGaugeStats(id, value);
        }

        function updateGaugeStats(id, value) {
            if (value < gaugeStats[id].min) gaugeStats[id].min = value;
            if (value > gaugeStats[id].max) gaugeStats[id].max = value;

            document.getElementById('min' + id).textContent = gaugeStats[id].min !== Infinity ? 
                gaugeStats[id].min.toFixed(1) : '--';
            document.getElementById('max' + id).textContent = gaugeStats[id].max !== -Infinity ? 
                gaugeStats[id].max.toFixed(1) : '--';
        }

        function setupFirebase() {
            const deviceId = '0a10aced202194944a053768';
            
            db.ref('.info/connected').on('value', snap => {
                const connected = snap.val();
                if (connected) {
                    updateBanner('connected', 'Conectado - Tiempo real');
                } else {
                    updateBanner('disconnected', 'Firebase desconectado');
                }
            });

            const lecturasRef = db.ref(`dispositivos/${deviceId}/lecturas`);

            lecturasRef.limitToLast(1).on('child_added', snap => {
                processNewestData(snap);
            });

            lecturasRef.limitToLast(1).on('child_changed', snap => {
                processNewestData(snap);
            });

            lecturasRef.on('value', snap => {
                const data = snap.val();
                if (data) {
                    allData = [];
                    
                    Object.entries(data).forEach(([year, months]) => {
                        Object.entries(months).forEach(([month, days]) => {
                            Object.entries(days).forEach(([day, hours]) => {
                                Object.entries(hours).forEach(([hour, readings]) => {
                                    Object.entries(readings).forEach(([id, reading]) => {
                                        allData.push({
                                            ...reading,
                                            id: id,
                                            year, month, day, hour,
                                            timestamp: reading.timestamp ? new Date(reading.timestamp).getTime() : Date.now()
                                        });
                                    });
                                });
                            });
                        });
                    });

                    allData.sort((a,b) => b.timestamp - a.timestamp);
                    console.log('üìä Datos cargados:', allData.length);
                    document.getElementById('totalCount').textContent = allData.length;
                    
                    filterTime('all');
                }
            });
        }

        function processNewestData(yearSnap) {
            const yearData = yearSnap.val();
            let latestReading = null;
            let latestTimestamp = 0;

            Object.values(yearData).forEach(months => {
                Object.values(months).forEach(days => {
                    Object.values(days).forEach(hours => {
                        Object.values(hours).forEach(reading => {
                            const ts = reading.timestamp ? new Date(reading.timestamp).getTime() : 0;
                            if (ts > latestTimestamp) {
                                latestTimestamp = ts;
                                latestReading = reading;
                            }
                        });
                    });
                });
            });

            if (latestReading) {
                processData(latestReading);
            }
        }

        function processData(data) {
            const parsed = {
                MQ7: parseFloat(data.MQ7) || 0,
                MQ135: parseFloat(data.MQ135) || 0,
                'PM1.0': parseFloat(data.PM1_0) || 0,
                'PM2.5': parseFloat(data.PM2_5) || 0,
                PM10: parseFloat(data.PM10) || 0,
                Temperature: parseFloat(data.Temperature) || 0,
                Pressure: parseFloat(data.Pressure) || 0,
                Altitude: parseFloat(data.Altitude) || 0
            };
            updateSensors(parsed);
        }

        function updateSensors(data) {
            const co = (data.MQ7 * 0.005).toFixed(1);
            const co2 = (data.MQ135 * 0.5).toFixed(0);

            document.getElementById('valCO').textContent = co;
            document.getElementById('valCO2').textContent = co2;
            document.getElementById('valPM1').textContent = data['PM1.0'] || 0;
            document.getElementById('valPM25').textContent = data['PM2.5'] || 0;
            document.getElementById('valPM10').textContent = data.PM10 || 0;
            document.getElementById('valTemp').textContent = data.Temperature.toFixed(1);
            document.getElementById('valPressure').textContent = data.Pressure.toFixed(1);

            updateGauge('CO', parseFloat(co));
            updateGauge('CO2', parseFloat(co2));
            updateGauge('PM1', data['PM1.0']);
            updateGauge('PM25', data['PM2.5']);
            updateGauge('PM10', data.PM10);
            updateGauge('Temp', data.Temperature);
            updateGauge('Pressure', data.Pressure);

            updateStatus('CO', parseFloat(co));
            updateStatus('CO2', parseFloat(co2));
            updateStatus('PM1', data['PM1.0']);
            updateStatus('PM25', data['PM2.5']);
            updateStatus('PM10', data.PM10);

            checkAlerts({
                CO: parseFloat(co),
                CO2: parseFloat(co2),
                PM1: data['PM1.0'],
                PM25: data['PM2.5'],
                PM10: data.PM10,
                Temp: data.Temperature
            });

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-MX');
        }

        function updateStatus(sensor, value) {
            const badge = document.getElementById('stat' + sensor);
            if (!badge || !THRESHOLDS[sensor]) return;

            const t = THRESHOLDS[sensor];
            if (value <= t.good) {
                badge.textContent = 'Bueno';
                badge.className = 'badge good';
            } else if (value <= t.moderate) {
                badge.textContent = 'Moderado';
                badge.className = 'badge moderate';
            } else {
                badge.textContent = 'Insalubre';
                badge.className = 'badge unhealthy';
            }
        }

        function checkAlerts(values) {
            if (values.CO > THRESHOLDS.CO.critical) showNotification(`‚ö†Ô∏è CO cr√≠tico: ${values.CO} ppm`);
            if (values.CO2 > THRESHOLDS.CO2.critical) showNotification(`‚ö†Ô∏è CO2 cr√≠tico: ${values.CO2} ppm`);
            if (values.PM1 > THRESHOLDS.PM1.critical) showNotification(`‚ö†Ô∏è PM1.0: ${values.PM1} ¬µg/m¬≥`);
            if (values.PM25 > THRESHOLDS.PM25.critical) showNotification(`‚ö†Ô∏è PM2.5: ${values.PM25} ¬µg/m¬≥`);
            if (values.PM10 > THRESHOLDS.PM10.critical) showNotification(`‚ö†Ô∏è PM10: ${values.PM10} ¬µg/m¬≥`);
            if (values.Temp > THRESHOLDS.Temp.critical) showNotification(`‚ö†Ô∏è Temperatura: ${values.Temp}¬∞C`);
        }

        function showNotification(text) {
            const notif = document.getElementById('notification');
            document.getElementById('notifText').textContent = text;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 5000);
        }

        function updateBanner(status, text) {
            const banner = document.getElementById('banner');
            banner.className = `banner ${status}`;
            banner.querySelector('.dot').className = `dot ${status}`;
            document.getElementById('bannerText').textContent = text;
        }

        function refreshData() {
            console.log('üîÑ Actualizando datos...');
            showNotification('üîÑ Actualizando datos...');
        }

        function checkForUpdates() {
            console.log('‚úì Verificaci√≥n autom√°tica');
        }

        // PREDICCIONES ML
        const PREDICTION_VARS = [
            {api: 'MQ7', name: 'CO (Mon√≥xido)', unit: 'ppm', convert: v => v * 0.005},
            {api: 'MQ135', name: 'CO2 (Di√≥xido)', unit: 'ppm', convert: v => v * 0.5},
            {api: 'PM1.0', name: 'PM1.0', unit: '¬µg/m¬≥', convert: v => v},
            {api: 'PM2.5', name: 'PM2.5', unit: '¬µg/m¬≥', convert: v => v},
            {api: 'PM10', name: 'PM10', unit: '¬µg/m¬≥', convert: v => v},
            {api: 'Temperatura', name: 'Temperatura', unit: '¬∞C', convert: v => v},
            {api: 'Presion', name: 'Presi√≥n', unit: 'Pa', convert: v => v},
            {api: 'Altitud', name: 'Altitud', unit: 'm', convert: v => v}
        ];

        async function loadPredictions() {
            if (!navigator.onLine) {
                alert('‚ö†Ô∏è Necesitas conexi√≥n a internet para generar predicciones');
                return;
            }

            if (allData.length === 0) {
                alert('‚ö†Ô∏è No hay datos hist√≥ricos. Espera a que se carguen datos de Firebase.');
                return;
            }

            document.getElementById('predictionsLoading').style.display = 'block';
            document.getElementById('predictionsContainer').innerHTML = '';

            try {
                showNotification('üìä Analizando datos hist√≥ricos...');
                
                // Intentar cargar predicciones de las APIs
                const predictions = await Promise.all(
                    PREDICTION_VARS.map(v => fetchPrediction(v))
                );

                document.getElementById('predictionsLoading').style.display = 'none';
                
                // Verificar si alguna predicci√≥n tiene datos
                const hasData = predictions.some(p => p.predictions && p.predictions.length > 0);
                
                if (hasData) {
                    displayPredictions(predictions);
                    showNotification('‚úÖ Predicciones generadas');
                } else {
                    throw new Error('No se pudieron obtener predicciones');
                }
                
            } catch (error) {
                console.error('Error en predicciones:', error);
                document.getElementById('predictionsLoading').style.display = 'none';
                
                // Mostrar mensaje amigable
                document.getElementById('predictionsContainer').innerHTML = `
                    <div class="card" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                        <h3 style="color: var(--platinum); margin-bottom: 1rem;">An√°lisis Estad√≠stico Local</h3>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                            Las APIs de ML no est√°n disponibles.<br>
                            Generando predicciones mediante an√°lisis estad√≠stico de datos hist√≥ricos.
                        </p>
                        <button class="btn btn-platinum" onclick="loadPredictionsFallback()">
                            üìà Generar An√°lisis Estad√≠stico
                        </button>
                    </div>
                `;
            }
        }

        // Funci√≥n alternativa que usa solo datos de Firebase
        async function loadPredictionsFallback() {
            document.getElementById('predictionsLoading').style.display = 'block';
            document.getElementById('predictionsContainer').innerHTML = '';

            // Simular delay
            await new Promise(resolve => setTimeout(resolve, 500));

            const predictions = PREDICTION_VARS.map(v => ({
                ...v,
                predictions: generateFallbackPredictions(v.api)
            }));

            document.getElementById('predictionsLoading').style.display = 'none';
            displayPredictions(predictions);
            showNotification('‚úÖ An√°lisis estad√≠stico completado');
        }

        async function fetchPrediction(variable) {
            const url = `https://web-production-08364.up.railway.app/predict/?column=${variable.api}`;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 segundos timeout
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                // Manejar diferentes formatos de respuesta
                let predictions = [];
                if (data.predictions) {
                    predictions = Array.isArray(data.predictions) ? data.predictions : [data.predictions];
                } else if (data.prediction) {
                    predictions = Array.isArray(data.prediction) ? data.prediction : [data.prediction];
                } else if (Array.isArray(data)) {
                    predictions = data;
                } else if (typeof data === 'number') {
                    predictions = [data];
                } else {
                    // Si no hay predicciones, generar datos simulados basados en √∫ltimas lecturas
                    predictions = generateFallbackPredictions(variable.api);
                }
                
                return {
                    ...variable,
                    predictions: predictions
                };
                
            } catch (error) {
                console.warn(`Error en ${variable.name}:`, error.message);
                // Generar predicciones simuladas basadas en datos hist√≥ricos
                return {
                    ...variable,
                    predictions: generateFallbackPredictions(variable.api)
                };
            }
        }

        function generateFallbackPredictions(apiName) {
            // Obtener √∫ltimas lecturas de Firebase
            const recentData = allData.slice(0, 50);
            
            if (recentData.length === 0) {
                // Si no hay datos, retornar valores por defecto
                return [0, 0, 0, 0, 0, 0, 0];
            }
            
            let values = [];
            
            // Extraer valores seg√∫n la variable
            switch(apiName) {
                case 'MQ7':
                    values = recentData.map(d => parseFloat(d.MQ7) || 0);
                    break;
                case 'MQ135':
                    values = recentData.map(d => parseFloat(d.MQ135) || 0);
                    break;
                case 'PM1.0':
                    values = recentData.map(d => parseFloat(d.PM1_0) || 0);
                    break;
                case 'PM2.5':
                    values = recentData.map(d => parseFloat(d.PM2_5) || 0);
                    break;
                case 'PM10':
                    values = recentData.map(d => parseFloat(d.PM10) || 0);
                    break;
                case 'Temperatura':
                    values = recentData.map(d => parseFloat(d.Temperature) || 0);
                    break;
                case 'Presion':
                    values = recentData.map(d => parseFloat(d.Pressure) || 0);
                    break;
                case 'Altitud':
                    values = recentData.map(d => parseFloat(d.Altitude) || 0);
                    break;
                default:
                    return [0, 0, 0, 0, 0, 0, 0];
            }
            
            // Calcular promedio de las √∫ltimas lecturas
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            
            // Calcular desviaci√≥n est√°ndar
            const variance = values.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            
            // Generar predicciones con variaci√≥n realista
            const predictions = [];
            for (let i = 0; i < 7; i++) {
                // A√±adir variaci√≥n peque√±a basada en desviaci√≥n est√°ndar
                const variation = (Math.random() - 0.5) * stdDev * 0.3;
                predictions.push(Math.max(0, avg + variation));
            }
            
            return predictions;
        }

        function displayPredictions(predictions) {
            const container = document.getElementById('predictionsContainer');
            
            container.innerHTML = predictions.map(pred => {
                const values = Array.isArray(pred.predictions) ? pred.predictions : [pred.predictions];
                const converted = values.map(v => pred.convert ? pred.convert(v).toFixed(2) : v.toFixed(2));
                
                return `
                    <div class="prediction-card">
                        <div class="prediction-header">
                            <div class="prediction-title">${pred.name}</div>
                            <div class="prediction-subtitle">Pr√≥ximos 7 d√≠as</div>
                        </div>
                        <div class="prediction-grid">
                            ${converted.map((val, idx) => `
                                <div class="prediction-day">
                                    <div class="prediction-day-label">D√≠a ${idx + 1}</div>
                                    <div class="prediction-day-value">${val}</div>
                                    <div class="prediction-day-unit">${pred.unit}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // CONTINUACI√ìN DEL C√ìDIGO ORIGINAL (FILTROS, HISTORIAL, GR√ÅFICAS, etc.)
        function filterTime(period) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');

            const now = new Date();
            let startTime, endTime;

            switch(period) {
                case 'first50':
                    filteredData = allData.slice(-50).reverse();
                    break;
                case 'today':
                    startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    filteredData = allData.filter(d => d.timestamp >= startTime);
                    break;
                case 'yesterday':
                    startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1).getTime();
                    endTime = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    filteredData = allData.filter(d => d.timestamp >= startTime && d.timestamp < endTime);
                    break;
                case 'week':
                    startTime = now.getTime() - (7 * 24 * 60 * 60 * 1000);
                    filteredData = allData.filter(d => d.timestamp >= startTime);
                    break;
                case 'month':
                    startTime = now.getTime() - (30 * 24 * 60 * 60 * 1000);
                    filteredData = allData.filter(d => d.timestamp >= startTime);
                    break;
                case 'all':
                default:
                    filteredData = [...allData];
            }

            document.getElementById('recordCount').textContent = filteredData.length;
            updateHistoryTable();
            updateCharts();
        }

        function filterCustomRange() {
            const from = new Date(document.getElementById('dateFrom').value).getTime();
            const to = new Date(document.getElementById('dateTo').value).getTime() + (24 * 60 * 60 * 1000);

            if (isNaN(from) || isNaN(to)) {
                alert('Por favor selecciona fechas v√°lidas');
                return;
            }

            filteredData = allData.filter(d => d.timestamp >= from && d.timestamp <= to);
            document.getElementById('recordCount').textContent = filteredData.length;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            updateHistoryTable();
            updateCharts();
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';
            
            filteredData.forEach(item => {
                const co = item.MQ7 ? (parseFloat(item.MQ7) * 0.005).toFixed(1) : '--';
                const co2 = item.MQ135 ? (parseFloat(item.MQ135) * 0.5).toFixed(0) : '--';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(item.timestamp).toLocaleString('es-MX')}</td>
                    <td>${co}</td>
                    <td>${co2}</td>
                    <td>${item.PM1_0 || 0}</td>
                    <td>${item.PM2_5 || 0}</td>
                    <td>${item.PM10 || 0}</td>
                    <td>${item.Temperature || '--'}</td>
                    <td>${item.Pressure || '--'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(allData.map(item => ({
                ID: item.id,
                Fecha: new Date(item.timestamp).toLocaleString('es-MX'),
                CO_ppm: item.MQ7 ? (parseFloat(item.MQ7) * 0.005).toFixed(1) : '',
                CO2_ppm: item.MQ135 ? (parseFloat(item.MQ135) * 0.5).toFixed(0) : '',
                'PM1.0': item.PM1_0,
                'PM2.5': item.PM2_5,
                PM10: item.PM10,
                Temperatura: item.Temperature,
                Presi√≥n: item.Pressure,
                Altitud: item.Altitude,
                MQ7_raw: item.MQ7,
                MQ135_raw: item.MQ135,
                Timestamp: item.timestamp
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Historial');
            XLSX.writeFile(wb, `AirGuard_${new Date().toISOString().split('T')[0]}.xlsx`);
            alert(`‚úÖ ${allData.length} registros exportados`);
        }

        function exportCSV() {
            const csv = [
                ['Fecha','CO','CO2','PM1.0','PM2.5','PM10','Temp','Presi√≥n','Alt','MQ7','MQ135'],
                ...allData.map(item => [
                    new Date(item.timestamp).toLocaleString('es-MX'),
                    item.MQ7 ? (parseFloat(item.MQ7) * 0.005).toFixed(1) : '',
                    item.MQ135 ? (parseFloat(item.MQ135) * 0.5).toFixed(0) : '',
                    item.PM1_0, item.PM2_5, item.PM10,
                    item.Temperature, item.Pressure, item.Altitude,
                    item.MQ7, item.MQ135
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AirGuard_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            alert(`‚úÖ ${allData.length} registros exportados`);
        }

        function showDeleteMenu() {
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteMenu() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        async function deleteRecent(count) {
            const password = prompt(`üîí Contrase√±a para borrar ${count}:`);
            if (!password || password !== 'Monitoreo#2025') { 
                if (password) alert('‚ùå Contrase√±a incorrecta'); 
                closeDeleteMenu(); 
                return; 
            }
            if (!confirm(`‚ö†Ô∏è ¬øBorrar ${count} lecturas?\n\nBackup autom√°tico.`)) { 
                closeDeleteMenu(); return; 
            }

            const backupData = allData.slice(0, count);
            exportBackup(backupData, `Backup_${count}`);

            try {
                const deviceId = '0a10aced202194944a053768';
                const toDelete = allData.slice(0, count);
                
                await Promise.all(toDelete.map(item => {
                    const path = `dispositivos/${deviceId}/lecturas/${item.year}/${item.month}/${item.day}/${item.hour}/${item.id}`;
                    return db.ref(path).remove();
                }));
                
                alert(`‚úÖ ${count} borradas. Backup guardado.`);
                closeDeleteMenu();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function deleteAll() {
            const password = prompt('üîí Contrase√±a:');
            if (!password || password !== 'Monitoreo#2025') { 
                if (password) alert('‚ùå Incorrecta'); 
                closeDeleteMenu(); return; 
            }
            if (!confirm('‚ö†Ô∏è ¬øBorrar TODO?')) { closeDeleteMenu(); return; }
            
            const confirmText = prompt('Escribe: BORRAR TODO');
            if (confirmText !== 'BORRAR TODO') { 
                alert('‚ùå Cancelado'); closeDeleteMenu(); return; 
            }

            exportBackup(allData, 'Backup_COMPLETO');
            try {
                const deviceId = '0a10aced202194944a053768';
                await db.ref(`dispositivos/${deviceId}/lecturas`).remove();
                allData = []; filteredData = [];
                updateHistoryTable(); updateCharts();
                alert('‚úÖ Todo borrado. Backup guardado.');
                closeDeleteMenu();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        function exportBackup(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data.map(item => ({
                ID: item.id, Fecha: new Date(item.timestamp).toLocaleString('es-MX'),
                MQ7: item.MQ7, MQ135: item.MQ135, 'PM1.0': item.PM1_0,
                'PM2.5': item.PM2_5, PM10: item.PM10, Temp: item.Temperature,
                Presi√≥n: item.Pressure, Alt: item.Altitude, Timestamp: item.timestamp
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Backup');
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // CHARTS - 8 gr√°ficas
        function createCharts() {
            const container = document.getElementById('chartsContainer');
            const chartDefs = [
                {id: 'CO', title: 'CO (Mon√≥xido de Carbono)', color: '#5e5e5e', unit: 'ppm'},
                {id: 'CO2', title: 'CO2 (Di√≥xido de Carbono)', color: '#0088CC', unit: 'ppm'},
                {id: 'PM1', title: 'PM1.0 (Part√≠culas Ultrafinas)', color: '#10B981', unit: '¬µg/m¬≥'},
                {id: 'PM25', title: 'PM2.5 (Part√≠culas Finas)', color: '#F59E0B', unit: '¬µg/m¬≥'},
                {id: 'PM10', title: 'PM10 (Part√≠culas Gruesas)', color: '#EF4444', unit: '¬µg/m¬≥'},
                {id: 'Temp', title: 'Temperatura', color: '#10B981', unit: '¬∞C'},
                {id: 'Pressure', title: 'Presi√≥n Atmosf√©rica', color: '#8B5CF6', unit: 'Pa'},
                {id: 'PMAll', title: 'Material Particulado (PM1.0, PM2.5, PM10)', color: null, unit: '¬µg/m¬≥'}
            ];

            container.innerHTML = chartDefs.map(c => `
                <div class="card">
                    <div class="chart-wrapper">
                        <div class="chart-title">${c.title}</div>
                        <canvas id="chart${c.id}"></canvas>
                    </div>
                </div>
            `).join('');

            chartDefs.forEach(c => {
                const ctx = document.getElementById('chart' + c.id).getContext('2d');
                if (c.id === 'PMAll') {
                    charts[c.id] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {label: 'PM1.0', data: [], borderColor: '#10B981', tension: 0.4, fill: false},
                                {label: 'PM2.5', data: [], borderColor: '#F59E0B', tension: 0.4, fill: false},
                                {label: 'PM10', data: [], borderColor: '#EF4444', tension: 0.4, fill: false}
                            ]
                        },
                        options: getChartOptions()
                    });
                } else {
                    charts[c.id] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: c.title.split('(')[0].trim(),
                                data: [],
                                borderColor: c.color,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: getChartOptions()
                    });
                }
            });
        }

        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {mode: 'index', intersect: false},
                plugins: {
                    legend: {display: true, position: 'top'},
                    tooltip: {mode: 'index', intersect: false}
                },
                scales: {
                    x: {
                        display: true,
                        grid: {display: true, color: 'rgba(0, 0, 0, 0.05)'},
                        ticks: {maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 15}
                    },
                    y: {
                        display: true,
                        grid: {display: true, color: 'rgba(0, 0, 0, 0.05)'}
                    }
                }
            };
        }

        function setChartRange(range) {
            chartRange = range;
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            updateCharts();
        }

        function filterChartCustomRange() {
            const from = new Date(document.getElementById('chartDateFrom').value).getTime();
            const to = new Date(document.getElementById('chartDateTo').value).getTime() + (24 * 60 * 60 * 1000);

            if (isNaN(from) || isNaN(to)) {
                alert('Fechas v√°lidas requeridas');
                return;
            }

            chartRange = 'custom';
            window.customChartRange = {from, to};
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            updateCharts();
        }

        function updateCharts() {
            let data = [];
            const now = new Date();

            switch(chartRange) {
                case 'last7': data = filteredData.slice(0, 7); break;
                case 'last10': data = filteredData.slice(0, 10); break;
                case 'last50': data = filteredData.slice(0, 50); break;
                case 'last100': data = filteredData.slice(0, 100); break;
                case 'hour':
                    data = filteredData.filter(d => d.timestamp >= (now.getTime() - 3600000));
                    break;
                case 'day':
                    data = filteredData.filter(d => d.timestamp >= new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime());
                    break;
                case 'week':
                    data = filteredData.filter(d => d.timestamp >= (now.getTime() - 7*24*60*60*1000));
                    break;
                case 'custom':
                    if (window.customChartRange) {
                        data = filteredData.filter(d => d.timestamp >= window.customChartRange.from && d.timestamp <= window.customChartRange.to);
                    }
                    break;
                default:
                    data = filteredData.slice(0, 50);
            }

            data = data.reverse();
            document.getElementById('chartDataCount').textContent = data.length;

            const labels = data.map(d => {
                const date = new Date(d.timestamp);
                if (['last7','last10','last50','last100','hour'].includes(chartRange)) {
                    return date.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
                }
                return date.toLocaleDateString('es-MX', {month: '2-digit', day: '2-digit', hour: '2-digit'});
            });

            charts.CO.data.labels = labels;
            charts.CO.data.datasets[0].data = data.map(d => d.MQ7 ? parseFloat(d.MQ7) * 0.005 : 0);
            charts.CO.update();

            charts.CO2.data.labels = labels;
            charts.CO2.data.datasets[0].data = data.map(d => d.MQ135 ? parseFloat(d.MQ135) * 0.5 : 400);
            charts.CO2.update();

            charts.PM1.data.labels = labels;
            charts.PM1.data.datasets[0].data = data.map(d => parseFloat(d.PM1_0) || 0);
            charts.PM1.update();

            charts.PM25.data.labels = labels;
            charts.PM25.data.datasets[0].data = data.map(d => parseFloat(d.PM2_5) || 0);
            charts.PM25.update();

            charts.PM10.data.labels = labels;
            charts.PM10.data.datasets[0].data = data.map(d => parseFloat(d.PM10) || 0);
            charts.PM10.update();

            charts.Temp.data.labels = labels;
            charts.Temp.data.datasets[0].data = data.map(d => parseFloat(d.Temperature) || 0);
            charts.Temp.update();

            charts.Pressure.data.labels = labels;
            charts.Pressure.data.datasets[0].data = data.map(d => parseFloat(d.Pressure) || 0);
            charts.Pressure.update();

            charts.PMAll.data.labels = labels;
            charts.PMAll.data.datasets[0].data = data.map(d => parseFloat(d.PM1_0) || 0);
            charts.PMAll.data.datasets[1].data = data.map(d => parseFloat(d.PM2_5) || 0);
            charts.PMAll.data.datasets[2].data = data.map(d => parseFloat(d.PM10) || 0);
            charts.PMAll.update();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            if (event && event.target) event.target.closest('.tab').classList.add('active');
        }

        // REPORTE PDF
        function generateReport() {
            if (!navigator.onLine) {
                alert('‚ö†Ô∏è Necesitas conexi√≥n a internet para generar el reporte');
                return;
            }

            if (typeof jspdf === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => setTimeout(generateReportPDF, 500);
                document.head.appendChild(script);
            } else {
                generateReportPDF();
            }
        }

        function generateReportPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('AirGuard', 105, 20, {align: 'center'});
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('REPORTE OFICIAL DE MONITOREO AMBIENTAL', 105, 30, {align: 'center'});
                doc.text('Instituto Tecnologico de Nuevo Leon', 105, 37, {align: 'center'});
                
                doc.setFontSize(10);
                doc.text(`Fecha: ${new Date().toLocaleDateString('es-MX', {year: 'numeric', month: 'long', day: 'numeric'})}`, 105, 44, {align: 'center'});
                doc.text(`Hora: ${new Date().toLocaleTimeString('es-MX')}`, 105, 50, {align: 'center'});
                
                doc.setDrawColor(94, 94, 94);
                doc.setLineWidth(0.5);
                doc.line(20, 55, 190, 55);
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('VALORES ACTUALES', 20, 65);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                let y = 75;
                
                const currentVals = [
                    ['CO', document.getElementById('valCO').textContent + ' ppm', document.getElementById('statCO').textContent],
                    ['CO2', document.getElementById('valCO2').textContent + ' ppm', document.getElementById('statCO2').textContent],
                    ['PM1.0', document.getElementById('valPM1').textContent + ' ug/m3', document.getElementById('statPM1') ? document.getElementById('statPM1').textContent : 'N/A'],
                    ['PM2.5', document.getElementById('valPM25').textContent + ' ug/m3', document.getElementById('statPM25').textContent],
                    ['PM10', document.getElementById('valPM10').textContent + ' ug/m3', document.getElementById('statPM10').textContent],
                    ['Temperatura', document.getElementById('valTemp').textContent + ' C', 'Normal'],
                    ['Presion', document.getElementById('valPressure').textContent + ' Pa', 'Normal']
                ];
                
                currentVals.forEach(([param, val, status]) => {
                    doc.text(param + ':', 25, y);
                    doc.setFont('helvetica', 'bold');
                    doc.text(val, 80, y);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`[${status}]`, 130, y);
                    y += 7;
                });
                
                y += 5;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('ESTADISTICAS', 20, y);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                y += 10;
                doc.text(`Total de registros: ${allData.length}`, 25, y);
                y += 7;
                const periodoText = allData.length > 0 ? 
                    `${new Date(allData[allData.length-1].timestamp).toLocaleDateString('es-MX')} - ${new Date(allData[0].timestamp).toLocaleDateString('es-MX')}` : 
                    'N/A';
                doc.text(`Periodo: ${periodoText}`, 25, y);
                
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text('Reporte generado por AirGuard', 105, 280, {align: 'center'});
                doc.text('Instituto Tecnologico de Nuevo Leon', 105, 285, {align: 'center'});
                
                const fileName = `Reporte_AirGuard_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Detectar Android
                const isAndroid = /android/i.test(navigator.userAgent);
                
                if (isAndroid) {
                    const pdfBlob = doc.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    showNotification('‚úÖ Reporte descargado. Revisa tu carpeta de Descargas');
                } else {
                    doc.save(fileName);
                    showNotification('‚úÖ Reporte PDF generado');
                }
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('‚ùå Error al generar reporte: ' + error.message);
            }
        }
    </script>
</body>
</html>
