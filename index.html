<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGuard 4.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0088CC; --success: #10B981; --warning: #F59E0B;
            --danger: #EF4444; --bg: #F8F9FA; --card: #FFF;
            --text: #1F2937; --text-light: #6B7280; --border: #E5E7EB;
            --platinum: #5e5e5e; --platinum-light: #858585;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); }
        
        /* Login */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; }
        .login-box { background: white; border-radius: 16px; padding: 2rem; width: 100%; max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-title { text-align: center; font-size: 2rem; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-input { width: 100%; padding: 0.875rem; border: 2px solid var(--border);
            border-radius: 8px; font-size: 1rem; }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .btn-login { width: 100%; padding: 1rem; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .message { padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .message.show { display: block; }
        .message.error { background: #FEE2E2; color: #991B1B; }
        .message.success { background: #D1FAE5; color: #065F46; }
        
        /* App */
        .app-container { display: none; }
        .app-container.active { display: block; }
        .header { background: linear-gradient(135deg, var(--platinum) 0%, var(--platinum-light) 100%);
            color: white; padding: 1rem; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .header-content { display: flex; justify-content: space-between; align-items: center; 
            max-width: 1200px; margin: 0 auto; }
        .app-title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
        .spark { font-size: 1.8rem; animation: sparkle 1.5s infinite; }
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        .btn-header { background: rgba(255,255,255,0.2); border: none; color: white;
            padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;
            transition: all 0.3s; }
        .btn-header:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        
        /* Banner */
        .banner { padding: 1rem; border-radius: 12px; margin-bottom: 1rem; display: flex;
            align-items: center; gap: 1rem; font-weight: 600; }
        .banner.connected { background: #D1FAE5; color: #065F46; border: 2px solid var(--success); }
        .banner.disconnected { background: #FEE2E2; color: #991B1B; border: 2px solid var(--danger); }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.connected { background: var(--success); animation: pulse 2s infinite; }
        .dot.disconnected { background: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Tabs - BOTTOM NAVIGATION (Android Style) */
        .tabs { 
            display: flex; 
            justify-content: space-around;
            align-items: center;
            gap: 0;
            padding: 0.5rem 0;
            background: white;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.15);
            border-top: 2px solid var(--platinum);
        }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { 
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.7rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateZ(0);
            color: var(--text-light);
            gap: 0.25rem;
        }
        .tab-icon {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        .tab.active { 
            color: var(--platinum);
            font-weight: 700;
        }
        .tab.active .tab-icon {
            transform: scale(1.2);
        }
        .tab:active {
            transform: scale(0.95);
        }
        
        /* Agregar padding-bottom al container para que no se tape con bottom nav */
        .container {
            padding-bottom: 80px;
        }
        .tab-content { 
            display: none;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-content.active { 
            display: block;
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Card */
        .card { background: white; border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;
            color: var(--platinum); }
        
        /* Gauge Grid */
        .gauge-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 1rem;
            justify-items: center; /* Centrar en m√≥viles */
            max-width: 100%;
            margin: 0 auto;
        }
        .gauge-container { 
            background: linear-gradient(145deg, #ffffff 0%, #f5f5f5 100%);
            border: 3px solid var(--platinum); 
            border-radius: 16px; 
            padding: 1rem;
            text-align: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 180px;
        }
        .gauge-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 0.5rem;
            font-size: 0.65rem;
            color: var(--platinum-light);
            font-weight: 600;
        }
        .gauge-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .gauge-stat-label {
            font-size: 0.6rem;
            opacity: 0.7;
        }
        .gauge-stat-value {
            font-weight: 700;
            color: var(--platinum);
        }
        .gauge-name { font-weight: 700; color: var(--platinum); margin-bottom: 0.5rem;
            font-size: 0.95rem; letter-spacing: 0.5px; }
        .gauge-canvas { margin: 0.5rem auto; }
        .gauge-value { font-size: 1.5rem; font-weight: 700; color: var(--platinum);
            margin: 0.5rem 0; }
        .gauge-unit { font-size: 0.85rem; color: var(--platinum-light); font-weight: 600; }
        .badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 12px;
            font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem; }
        .badge.good { background: #D1FAE5; color: #065F46; }
        .badge.moderate { background: #FEF3C7; color: #92400E; }
        .badge.unhealthy { background: #FEE2E2; color: #991B1B; }
        
        /* Filters */
        .filters { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;
            border: 2px solid var(--platinum); }
        .filter-title { font-weight: 700; color: var(--platinum); margin-bottom: 1rem; }
        .filter-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem; margin-bottom: 1rem; }
        .filter-btn { padding: 0.75rem; border: 2px solid var(--border); background: white;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;
            font-size: 0.9rem; }
        .filter-btn.active { background: var(--platinum); color: white; border-color: var(--platinum); }
        .filter-btn:hover { border-color: var(--platinum); }
        .custom-range { display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem;
            align-items: center; }
        .date-input { padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px;
            font-size: 0.9rem; }
        
        /* Table */
        .table-container { overflow-x: auto; border-radius: 12px; border: 2px solid var(--platinum); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        thead { background: linear-gradient(135deg, var(--platinum) 0%, var(--platinum-light) 100%); 
            color: white; }
        th, td { padding: 0.875rem; text-align: left; font-size: 0.9rem; }
        tbody tr:nth-child(even) { background: #FAFAFA; }
        tbody tr:hover { background: #F0F0F0; }
        .records-info { padding: 0.75rem; background: #F0F0F0; border-radius: 8px;
            margin-bottom: 1rem; text-align: center; font-weight: 600; color: var(--platinum); }
        
        /* Buttons */
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-platinum { background: var(--platinum); color: white; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 16px; padding: 2rem; max-width: 400px;
            width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem;
            color: var(--platinum); }
        
        /* Chart */
        .chart-wrapper { 
            margin-bottom: 1rem; 
            padding: 1rem;
        }
        .chart-controls { 
            display: flex; 
            gap: 0.5rem; 
            margin-bottom: 1rem; 
            flex-wrap: wrap;
            justify-content: center;
        }
        .chart-btn { 
            padding: 0.75rem 1.25rem; 
            border: 2px solid var(--border); 
            background: white;
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chart-btn.active { 
            background: var(--platinum); 
            color: white; 
            border-color: var(--platinum);
            transform: scale(1.05);
        }
        .chart-btn:active {
            transform: scale(0.95);
        }
        .chart-title { 
            font-weight: 700; 
            color: var(--platinum); 
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        canvas { 
            max-height: 350px; 
            width: 100% !important;
        }
        
        /* Notification */
        .notification { position: fixed; top: 80px; right: 20px; background: white;
            border-left: 4px solid var(--danger); border-radius: 8px; padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 300px; display: none;
            z-index: 1000; animation: slideIn 0.3s; }
        .notification.show { display: block; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .notif-title { font-weight: 700; margin-bottom: 0.5rem; }
        
        @media (max-width: 768px) {
            .gauge-grid { 
                grid-template-columns: repeat(2, 1fr);
                padding: 0 0.5rem;
            }
            .gauge-container {
                max-width: 100%;
            }
            .filter-buttons { grid-template-columns: repeat(2, 1fr); }
            .custom-range { grid-template-columns: 1fr; }
            .chart-controls { justify-content: center; }
            canvas { max-height: 200px; }
            .tab {
                font-size: 0.65rem;
                padding: 0.4rem;
            }
            .tab-icon {
                font-size: 1.3rem;
            }
        }
        
        @media (max-width: 360px) {
            .gauge-grid {
                grid-template-columns: 1fr;
                max-width: 280px;
                margin: 0 auto;
            }
            .tab {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-title">‚ö° AirGuard 4.0</div>
            <div id="loginError" class="message error"></div>
            <div id="loginSuccess" class="message success"></div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="email" id="email" class="form-input" placeholder="Email" 
                           value="admin@monitoreo.com" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" class="form-input" placeholder="Contrase√±a" 
                           value="Monitoreo#2025" required>
                </div>
                <button type="submit" class="btn-login">Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <!-- App -->
    <div id="appContainer" class="app-container">
        <div id="notification" class="notification">
            <div class="notif-title">‚ö†Ô∏è Alerta</div>
            <div id="notifText"></div>
        </div>

        <div class="header">
            <div class="header-content">
                <div class="app-title">
                    <span class="spark">‚ö°</span>
                    <span>AirGuard 4.0</span>
                </div>
                <button class="btn-header" onclick="logout()">üö™ Salir</button>
            </div>
        </div>

        <div class="container">
            <div id="banner" class="banner disconnected">
                <div class="dot disconnected"></div>
                <span id="bannerText">Conectando...</span>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">
                    <div class="tab-icon">‚ö°</div>
                    <div>Dashboard</div>
                </button>
                <button class="tab" onclick="switchTab('adicional')">
                    <div class="tab-icon">üìã</div>
                    <div>Adicional</div>
                </button>
                <button class="tab" onclick="switchTab('historial')">
                    <div class="tab-icon">üìú</div>
                    <div>Historial</div>
                </button>
                <button class="tab" onclick="switchTab('graficas')">
                    <div class="tab-icon">üìà</div>
                    <div>Gr√°ficas</div>
                </button>
                <button class="tab" onclick="switchTab('prediccion')">
                    <div class="tab-icon">üîÆ</div>
                    <div>Predicci√≥n</div>
                </button>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <div class="card-header">‚ö° Variables Cr√≠ticas</div>
                    <div class="gauge-grid">
                        <div class="gauge-container">
                            <div class="gauge-name">CO</div>
                            <canvas id="gaugeCO" class="gauge-canvas" width="120" height="120"></canvas>
                            <div class="gauge-value" id="valCO">--</div>
                            <div class="gauge-unit">ppm</div>
                            <div class="badge good" id="statCO">Sin datos</div>
                            <div class="gauge-stats">
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√≠n</div>
                                    <div class="gauge-stat-value" id="minCO">--</div>
                                </div>
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√°x</div>
                                    <div class="gauge-stat-value" id="maxCO">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-name">CO2</div>
                            <canvas id="gaugeCO2" class="gauge-canvas" width="120" height="120"></canvas>
                            <div class="gauge-value" id="valCO2">--</div>
                            <div class="gauge-unit">ppm</div>
                            <div class="badge good" id="statCO2">Sin datos</div>
                            <div class="gauge-stats">
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√≠n</div>
                                    <div class="gauge-stat-value" id="minCO2">--</div>
                                </div>
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√°x</div>
                                    <div class="gauge-stat-value" id="maxCO2">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-name">PM2.5</div>
                            <canvas id="gaugePM25" class="gauge-canvas" width="120" height="120"></canvas>
                            <div class="gauge-value" id="valPM25">--</div>
                            <div class="gauge-unit">¬µg/m¬≥</div>
                            <div class="badge good" id="statPM25">Sin datos</div>
                            <div class="gauge-stats">
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√≠n</div>
                                    <div class="gauge-stat-value" id="minPM25">--</div>
                                </div>
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√°x</div>
                                    <div class="gauge-stat-value" id="maxPM25">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-name">PM10</div>
                            <canvas id="gaugePM10" class="gauge-canvas" width="120" height="120"></canvas>
                            <div class="gauge-value" id="valPM10">--</div>
                            <div class="gauge-unit">¬µg/m¬≥</div>
                            <div class="badge good" id="statPM10">Sin datos</div>
                            <div class="gauge-stats">
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√≠n</div>
                                    <div class="gauge-stat-value" id="minPM10">--</div>
                                </div>
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√°x</div>
                                    <div class="gauge-stat-value" id="maxPM10">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-name">TEMP</div>
                            <canvas id="gaugeTemp" class="gauge-canvas" width="120" height="120"></canvas>
                            <div class="gauge-value" id="valTemp">--</div>
                            <div class="gauge-unit">¬∞C</div>
                            <div class="badge good">Normal</div>
                            <div class="gauge-stats">
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√≠n</div>
                                    <div class="gauge-stat-value" id="minTemp">--</div>
                                </div>
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√°x</div>
                                    <div class="gauge-stat-value" id="maxTemp">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-name">PRESI√ìN</div>
                            <canvas id="gaugePressure" class="gauge-canvas" width="120" height="120"></canvas>
                            <div class="gauge-value" id="valPressure">--</div>
                            <div class="gauge-unit">Pa</div>
                            <div class="badge good">Normal</div>
                            <div class="gauge-stats">
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√≠n</div>
                                    <div class="gauge-stat-value" id="minPressure">--</div>
                                </div>
                                <div class="gauge-stat">
                                    <div class="gauge-stat-label">M√°x</div>
                                    <div class="gauge-stat-value" id="maxPressure">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adicional -->
            <div id="adicional" class="tab-content">
                <div class="card">
                    <div class="card-header">üìã Datos T√©cnicos (Valores Brutos)</div>
                    <div class="gauge-grid">
                        <div class="gauge-container">
                            <div class="gauge-name">MQ7</div>
                            <div class="gauge-value" id="valMQ7">--</div>
                            <div class="gauge-unit">Anal√≥gico</div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-name">MQ135</div>
                            <div class="gauge-value" id="valMQ135">--</div>
                            <div class="gauge-unit">Anal√≥gico</div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-name">PM1.0</div>
                            <div class="gauge-value" id="valPM1">--</div>
                            <div class="gauge-unit">¬µg/m¬≥</div>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge-name">ALTITUD</div>
                            <div class="gauge-value" id="valAlt">--</div>
                            <div class="gauge-unit">metros</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial -->
            <div id="historial" class="tab-content">
                <div class="card">
                    <div class="card-header">üìú Historial Completo</div>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-title">üîç Filtrar por Tiempo</div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" onclick="filterTime('all')">Todo</button>
                            <button class="filter-btn" onclick="filterTime('today')">Hoy</button>
                            <button class="filter-btn" onclick="filterTime('yesterday')">Ayer</button>
                            <button class="filter-btn" onclick="filterTime('week')">7 d√≠as</button>
                            <button class="filter-btn" onclick="filterTime('month')">30 d√≠as</button>
                        </div>
                        <div class="custom-range">
                            <input type="date" id="dateFrom" class="date-input">
                            <input type="date" id="dateTo" class="date-input">
                            <button class="btn btn-platinum" onclick="filterCustomRange()">Aplicar</button>
                        </div>
                    </div>

                    <div class="records-info">
                        üìä Mostrando <span id="recordCount">0</span> de <span id="totalCount">0</span> registros
                    </div>

                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="exportExcel()">üìä Excel Completo</button>
                        <button class="btn btn-primary" onclick="exportCSV()">üìÑ CSV Completo</button>
                        <button class="btn btn-danger" onclick="showDeleteMenu()">üóëÔ∏è Borrar</button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th><th>CO</th><th>CO2</th><th>PM2.5</th>
                                    <th>PM10</th><th>Temp</th><th>Presi√≥n</th><th>Alt</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficas -->
            <div id="graficas" class="tab-content">
                <!-- Controles FUERA de las gr√°ficas -->
                <div class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, var(--platinum) 0%, var(--platinum-light) 100%);">
                    <div style="color: white; font-weight: 700; margin-bottom: 1rem;">
                        ‚è±Ô∏è Rango de Tiempo
                    </div>
                    <div class="chart-controls">
                        <button class="chart-btn active" onclick="setChartRange('last50')" style="background: white; color: var(--platinum);">
                            √öltimas 50
                        </button>
                        <button class="chart-btn" onclick="setChartRange('last100')" style="background: white; color: var(--platinum);">
                            √öltimas 100
                        </button>
                        <button class="chart-btn" onclick="setChartRange('hour')" style="background: white; color: var(--platinum);">
                            √öltima Hora
                        </button>
                        <button class="chart-btn" onclick="setChartRange('day')" style="background: white; color: var(--platinum);">
                            Hoy
                        </button>
                        <button class="chart-btn" onclick="setChartRange('week')" style="background: white; color: var(--platinum);">
                            7 D√≠as
                        </button>
                        <button class="chart-btn" onclick="setChartRange('all')" style="background: white; color: var(--platinum);">
                            Todo
                        </button>
                    </div>
                    <div style="color: white; font-size: 0.85rem; margin-top: 0.5rem; text-align: center;">
                        üìä Mostrando <span id="chartDataCount">0</span> lecturas
                    </div>
                </div>

                <!-- Gr√°ficas individuales -->
                <div class="card">
                    <div class="chart-wrapper">
                        <div class="chart-title">CO (Mon√≥xido de Carbono)</div>
                        <canvas id="chartCO"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-wrapper">
                        <div class="chart-title">CO2 (Di√≥xido de Carbono)</div>
                        <canvas id="chartCO2"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-wrapper">
                        <div class="chart-title">PM2.5 y PM10 (Part√≠culas)</div>
                        <canvas id="chartPM"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-wrapper">
                        <div class="chart-title">Temperatura</div>
                        <canvas id="chartTemp"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="chart-wrapper">
                        <div class="chart-title">Presi√≥n Atmosf√©rica</div>
                        <canvas id="chartPressure"></canvas>
                    </div>
                </div>
            </div>

            <!-- Predicci√≥n -->
            <div id="prediccion" class="tab-content">
                <div class="card">
                    <div class="card-header">üîÆ Predicciones y An√°lisis</div>
                    <div style="padding: 3rem; text-align: center; color: var(--text-light);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                        <h3>Secci√≥n en Desarrollo</h3>
                        <p style="margin-top: 1rem;">Algoritmos de Machine Learning para predicci√≥n de tendencias.</p>
                        <p style="margin-top: 0.5rem;">An√°lisis estad√≠stico avanzado pr√≥ximamente...</p>
                    </div>
                </div>
            </div>

            <div style="text-align: center; color: var(--text-light); font-size: 0.85rem; margin-top: 1rem;">
                üïê √öltima actualizaci√≥n: <span id="lastUpdate">--</span>
            </div>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">üóëÔ∏è Opciones de Borrado</div>
                <button class="btn btn-danger" onclick="deleteRecent(50)" style="width: 100%; margin-bottom: 0.75rem;">
                    Borrar √∫ltimas 50
                </button>
                <button class="btn btn-danger" onclick="deleteRecent(100)" style="width: 100%; margin-bottom: 0.75rem;">
                    Borrar √∫ltimas 100
                </button>
                <button class="btn btn-danger" onclick="deleteRecent(500)" style="width: 100%; margin-bottom: 0.75rem;">
                    Borrar √∫ltimas 500
                </button>
                <button class="btn btn-danger" onclick="deleteAll()" style="width: 100%; margin-bottom: 1rem;">
                    üö® Borrar TODO
                </button>
                <button class="btn btn-primary" onclick="closeDeleteMenu()" style="width: 100%;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDXf14TEST2aoTbiA-ciF2Dm9_oYCddp3g",
            authDomain: "app-monitoreo-itnl-v0.firebaseapp.com",
            databaseURL: "https://app-monitoreo-itnl-v0-default-rtdb.firebaseio.com",
            projectId: "app-monitoreo-itnl-v0",
            storageBucket: "app-monitoreo-itnl-v0.firebasestorage.app",
            messagingSenderId: "488643441374",
            appId: "1:488643441374:web:d4cced988c096d31e8884f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let allData = []; // TODOS los datos
        let filteredData = []; // Datos filtrados
        let charts = {};
        let gauges = {};
        let chartRange = 'last50'; // DEFAULT: Mostrar √∫ltimas 50 para mejor visualizaci√≥n

        const THRESHOLDS = {
            CO: {good: 9, moderate: 35, critical: 50, max: 100},
            CO2: {good: 1000, moderate: 2000, critical: 5000, max: 5000},
            PM25: {good: 12, moderate: 35.4, critical: 55.4, max: 150},
            PM10: {good: 54, moderate: 154, critical: 254, max: 350},
            Temp: {good: 25, moderate: 30, critical: 35, max: 50},
            Pressure: {good: 1013, moderate: 1020, critical: 1030, max: 1050}
        };

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = e.target.querySelector('.btn-login');

            btn.disabled = true;
            btn.textContent = 'Iniciando...';

            try {
                const cred = await auth.signInWithEmailAndPassword(email, password);
                currentUser = cred.user;
                console.log('‚úÖ Login OK');

                document.getElementById('loginSuccess').textContent = '¬°Bienvenido!';
                document.getElementById('loginSuccess').classList.add('show');

                setTimeout(() => {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('appContainer').classList.add('active');
                    initApp();
                }, 1000);
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
                document.getElementById('loginError').classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Iniciar Sesi√≥n';
            }
        });

        function logout() {
            auth.signOut();
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('loginContainer').style.display = 'flex';
        }

        // Init
        function initApp() {
            console.log('üöÄ Iniciando AirGuard 4.0...');
            initGauges();
            initCharts();
            setupFirebase();
            updateBanner('connected', 'Conectado - Tiempo real');
            
            // Set date inputs to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
        }

        // Gauges
        function initGauges() {
            const gaugeIds = ['CO', 'CO2', 'PM25', 'PM10', 'Temp', 'Pressure'];
            gaugeIds.forEach(id => {
                const canvas = document.getElementById('gauge' + id);
                const ctx = canvas.getContext('2d');
                gauges[id] = { canvas, ctx, value: 0 };
                drawGauge(id, 0);
            });
        }

        function drawGauge(id, value) {
            const gauge = gauges[id];
            const ctx = gauge.ctx;
            const canvas = gauge.canvas;
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const radius = Math.min(w, h) / 2 - 10;

            ctx.clearRect(0, 0, w, h);

            // Background arc
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0.75 * Math.PI, 2.25 * Math.PI);
            ctx.lineWidth = 12;
            ctx.strokeStyle = '#E5E7EB';
            ctx.stroke();

            // Calculate percentage
            const threshold = THRESHOLDS[id];
            const percent = Math.min(value / threshold.max, 1);
            const endAngle = 0.75 * Math.PI + percent * 1.5 * Math.PI;

            // Value arc with gradient
            const gradient = ctx.createLinearGradient(0, 0, w, 0);
            if (value <= threshold.good) {
                gradient.addColorStop(0, '#10B981');
                gradient.addColorStop(1, '#34D399');
            } else if (value <= threshold.moderate) {
                gradient.addColorStop(0, '#F59E0B');
                gradient.addColorStop(1, '#FBBF24');
            } else {
                gradient.addColorStop(0, '#EF4444');
                gradient.addColorStop(1, '#F87171');
            }

            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0.75 * Math.PI, endAngle);
            ctx.lineWidth = 12;
            ctx.strokeStyle = gradient;
            ctx.lineCap = 'round';
            ctx.stroke();

            // Center circle (platinum style)
            ctx.beginPath();
            ctx.arc(cx, cy, radius - 20, 0, 2 * Math.PI);
            ctx.fillStyle = '#5e5e5e';
            ctx.fill();

            // Inner shine
            ctx.beginPath();
            ctx.arc(cx, cy, radius - 22, 0, 2 * Math.PI);
            ctx.fillStyle = '#858585';
            ctx.fill();

            // AGUJA/BUJ√çA (Needle)
            const needleLength = radius - 25;
            const needleAngle = 0.75 * Math.PI + percent * 1.5 * Math.PI;
            const needleX = cx + Math.cos(needleAngle) * needleLength;
            const needleY = cy + Math.sin(needleAngle) * needleLength;

            // Needle shadow
            ctx.beginPath();
            ctx.moveTo(cx + 2, cy + 2);
            ctx.lineTo(needleX + 2, needleY + 2);
            ctx.lineWidth = 3;
            ctx.strokeStyle = 'rgba(0,0,0,0.3)';
            ctx.lineCap = 'round';
            ctx.stroke();

            // Needle
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(needleX, needleY);
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#ffffff';
            ctx.lineCap = 'round';
            ctx.stroke();

            // Needle center bolt
            ctx.beginPath();
            ctx.arc(cx, cy, 4, 0, 2 * Math.PI);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            ctx.strokeStyle = '#5e5e5e';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function updateGauge(id, value) {
            drawGauge(id, value);
            updateGaugeStats(id, value);
        }

        // Estad√≠sticas por gauge
        const gaugeStats = {
            CO: {min: Infinity, max: -Infinity},
            CO2: {min: Infinity, max: -Infinity},
            PM25: {min: Infinity, max: -Infinity},
            PM10: {min: Infinity, max: -Infinity},
            Temp: {min: Infinity, max: -Infinity},
            Pressure: {min: Infinity, max: -Infinity}
        };

        function updateGaugeStats(id, value) {
            if (value < gaugeStats[id].min) gaugeStats[id].min = value;
            if (value > gaugeStats[id].max) gaugeStats[id].max = value;

            document.getElementById('min' + id).textContent = gaugeStats[id].min !== Infinity ? 
                gaugeStats[id].min.toFixed(1) : '--';
            document.getElementById('max' + id).textContent = gaugeStats[id].max !== -Infinity ? 
                gaugeStats[id].max.toFixed(1) : '--';
        }

        // Firebase - CARGAR TODO
        function setupFirebase() {
            db.ref('.info/connected').on('value', snap => {
                const connected = snap.val();
                console.log('Firebase:', connected ? 'Conectado ‚úÖ' : 'Desconectado ‚ùå');
                if (connected) {
                    updateBanner('connected', 'Conectado - Tiempo real');
                } else {
                    updateBanner('disconnected', 'Firebase desconectado');
                }
            });

            // Escuchar √∫ltima lectura
            db.ref('lecturas').limitToLast(1).on('child_added', snap => {
                const data = snap.val();
                console.log('üì° Nueva lectura:', data);
                processData(data);
            });

            db.ref('lecturas').limitToLast(1).on('child_changed', snap => {
                const data = snap.val();
                console.log('üì° Lectura actualizada:', data);
                processData(data);
            });

            // Cargar TODOS los datos (sin l√≠mite)
            db.ref('lecturas').on('value', snap => {
                const data = snap.val();
                if (data) {
                    allData = Object.entries(data).map(([key, val]) => ({
                        ...val,
                        id: key,
                        timestamp: val.timestamp ? new Date(val.timestamp).getTime() : Date.now()
                    })).sort((a,b) => b.timestamp - a.timestamp);

                    console.log('üìä Base de datos completa cargada:', allData.length, 'registros');
                    document.getElementById('totalCount').textContent = allData.length;
                    
                    filterTime('all'); // Mostrar todo por defecto
                }
            });
        }

        function processData(data) {
            const parsed = {
                MQ7: parseFloat(data.MQ7) || 0,
                MQ135: parseFloat(data.MQ135) || 0,
                'PM1.0': parseFloat(data.PM1_0) || 0,
                'PM2.5': parseFloat(data.PM2_5) || 0,
                PM10: parseFloat(data.PM10) || 0,
                Temperature: parseFloat(data.Temperature) || 0,
                Pressure: parseFloat(data.Pressure) || 0,
                Altitude: parseFloat(data.Altitude) || 0
            };
            updateSensors(parsed);
        }

        function updateSensors(data) {
            const co = (data.MQ7 * 0.005).toFixed(1);
            const co2 = (data.MQ135 * 0.5).toFixed(0);

            // Update values
            document.getElementById('valCO').textContent = co;
            document.getElementById('valCO2').textContent = co2;
            document.getElementById('valPM25').textContent = data['PM2.5'] || 0;
            document.getElementById('valPM10').textContent = data.PM10 || 0;
            document.getElementById('valTemp').textContent = data.Temperature.toFixed(1);
            document.getElementById('valPressure').textContent = data.Pressure.toFixed(1);
            document.getElementById('valMQ7').textContent = data.MQ7;
            document.getElementById('valMQ135').textContent = data.MQ135;
            document.getElementById('valPM1').textContent = data['PM1.0'] || 0;
            document.getElementById('valAlt').textContent = data.Altitude.toFixed(1);

            // Update gauges
            updateGauge('CO', parseFloat(co));
            updateGauge('CO2', parseFloat(co2));
            updateGauge('PM25', data['PM2.5']);
            updateGauge('PM10', data.PM10);
            updateGauge('Temp', data.Temperature);
            updateGauge('Pressure', data.Pressure);

            // Update status
            updateStatus('CO', parseFloat(co));
            updateStatus('CO2', parseFloat(co2));
            updateStatus('PM25', data['PM2.5']);
            updateStatus('PM10', data.PM10);

            checkAlerts({
                CO: parseFloat(co),
                CO2: parseFloat(co2),
                PM25: data['PM2.5'],
                PM10: data.PM10,
                Temp: data.Temperature
            });

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-MX');
        }

        function updateStatus(sensor, value) {
            const badge = document.getElementById('stat' + sensor);
            if (!badge || !THRESHOLDS[sensor]) return;

            const t = THRESHOLDS[sensor];
            if (value <= t.good) {
                badge.textContent = 'Bueno';
                badge.className = 'badge good';
            } else if (value <= t.moderate) {
                badge.textContent = 'Moderado';
                badge.className = 'badge moderate';
            } else {
                badge.textContent = 'Insalubre';
                badge.className = 'badge unhealthy';
            }
        }

        function checkAlerts(values) {
            if (values.CO > THRESHOLDS.CO.critical) showNotification(`‚ö†Ô∏è CO cr√≠tico: ${values.CO} ppm`);
            if (values.CO2 > THRESHOLDS.CO2.critical) showNotification(`‚ö†Ô∏è CO2 cr√≠tico: ${values.CO2} ppm`);
            if (values.PM25 > THRESHOLDS.PM25.critical) showNotification(`‚ö†Ô∏è PM2.5: ${values.PM25} ¬µg/m¬≥`);
            if (values.PM10 > THRESHOLDS.PM10.critical) showNotification(`‚ö†Ô∏è PM10: ${values.PM10} ¬µg/m¬≥`);
            if (values.Temp > THRESHOLDS.Temp.critical) showNotification(`‚ö†Ô∏è Temperatura: ${values.Temp}¬∞C`);
        }

        function showNotification(text) {
            const notif = document.getElementById('notification');
            document.getElementById('notifText').textContent = text;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 5000);
        }

        function updateBanner(status, text) {
            const banner = document.getElementById('banner');
            banner.className = `banner ${status}`;
            banner.querySelector('.dot').className = `dot ${status}`;
            document.getElementById('bannerText').textContent = text;
        }

        // Filters
        function filterTime(period) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const now = new Date();
            let startTime;

            switch(period) {
                case 'today':
                    startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    break;
                case 'yesterday':
                    startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1).getTime();
                    const endYesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    filteredData = allData.filter(d => d.timestamp >= startTime && d.timestamp < endYesterday);
                    document.getElementById('recordCount').textContent = filteredData.length;
                    updateHistoryTable();
                    updateCharts();
                    return;
                case 'week':
                    startTime = now.getTime() - (7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startTime = now.getTime() - (30 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                default:
                    filteredData = [...allData];
                    document.getElementById('recordCount').textContent = filteredData.length;
                    updateHistoryTable();
                    updateCharts();
                    return;
            }

            filteredData = allData.filter(d => d.timestamp >= startTime);
            document.getElementById('recordCount').textContent = filteredData.length;
            updateHistoryTable();
            updateCharts();
        }

        function filterCustomRange() {
            const from = new Date(document.getElementById('dateFrom').value).getTime();
            const to = new Date(document.getElementById('dateTo').value).getTime() + (24 * 60 * 60 * 1000);

            if (isNaN(from) || isNaN(to)) {
                alert('Por favor selecciona fechas v√°lidas');
                return;
            }

            filteredData = allData.filter(d => d.timestamp >= from && d.timestamp <= to);
            document.getElementById('recordCount').textContent = filteredData.length;
            
            // Remove active from buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            updateHistoryTable();
            updateCharts();
        }

        // History Table
        function updateHistoryTable() {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';
            
            filteredData.forEach(item => {
                const co = item.MQ7 ? (parseFloat(item.MQ7) * 0.005).toFixed(1) : '--';
                const co2 = item.MQ135 ? (parseFloat(item.MQ135) * 0.5).toFixed(0) : '--';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(item.timestamp).toLocaleString('es-MX')}</td>
                    <td>${co}</td>
                    <td>${co2}</td>
                    <td>${item.PM2_5 || 0}</td>
                    <td>${item.PM10 || 0}</td>
                    <td>${item.Temperature || '--'}</td>
                    <td>${item.Pressure || '--'}</td>
                    <td>${item.Altitude || '--'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Export - TODO completo
        function exportExcel() {
            console.log('üìä Exportando', allData.length, 'registros a Excel...');
            
            const ws = XLSX.utils.json_to_sheet(allData.map(item => ({
                ID: item.id,
                Fecha: new Date(item.timestamp).toLocaleString('es-MX'),
                CO_ppm: item.MQ7 ? (parseFloat(item.MQ7) * 0.005).toFixed(1) : '',
                CO2_ppm: item.MQ135 ? (parseFloat(item.MQ135) * 0.5).toFixed(0) : '',
                'PM2.5': item.PM2_5,
                PM10: item.PM10,
                'PM1.0': item.PM1_0,
                Temperatura: item.Temperature,
                Presi√≥n: item.Pressure,
                Altitud: item.Altitude,
                MQ7_raw: item.MQ7,
                MQ135_raw: item.MQ135,
                Timestamp: item.timestamp
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Historial Completo');
            XLSX.writeFile(wb, `AirGuard_COMPLETO_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert(`‚úÖ ${allData.length} registros exportados a Excel`);
        }

        function exportCSV() {
            console.log('üìÑ Exportando', allData.length, 'registros a CSV...');
            
            const csv = [
                ['Fecha','CO','CO2','PM2.5','PM10','PM1.0','Temp','Presi√≥n','Altitud','MQ7','MQ135'],
                ...allData.map(item => [
                    new Date(item.timestamp).toLocaleString('es-MX'),
                    item.MQ7 ? (parseFloat(item.MQ7) * 0.005).toFixed(1) : '',
                    item.MQ135 ? (parseFloat(item.MQ135) * 0.5).toFixed(0) : '',
                    item.PM2_5, item.PM10, item.PM1_0,
                    item.Temperature, item.Pressure, item.Altitude,
                    item.MQ7, item.MQ135
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AirGuard_COMPLETO_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            alert(`‚úÖ ${allData.length} registros exportados a CSV`);
        }

        // Delete Functions
        function showDeleteMenu() {
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteMenu() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        async function deleteRecent(count) {
            const password = prompt(`üîí Para borrar las √∫ltimas ${count} lecturas, ingresa la contrase√±a:`);
            if (!password) { closeDeleteMenu(); return; }
            if (password !== 'Monitoreo#2025') { alert('‚ùå Contrase√±a incorrecta'); return; }
            if (!confirm(`‚ö†Ô∏è ¬øBorrar las √∫ltimas ${count} lecturas?\n\nSe crear√° backup autom√°tico.`)) { 
                closeDeleteMenu(); return; 
            }

            const backupData = allData.slice(0, count);
            exportBackup(backupData, `Backup_${count}_lecturas`);

            try {
                const toDelete = allData.slice(0, count);
                const deletePromises = toDelete.map(item => db.ref(`lecturas/${item.id}`).remove());
                await Promise.all(deletePromises);
                alert(`‚úÖ ${count} lecturas borradas.\nüì¶ Backup guardado.`);
                closeDeleteMenu();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function deleteAll() {
            const password = prompt('üîí Contrase√±a para borrar TODO:');
            if (!password) { closeDeleteMenu(); return; }
            if (password !== 'Monitoreo#2025') { alert('‚ùå Contrase√±a incorrecta'); return; }
            if (!confirm('‚ö†Ô∏è ¬øBorrar TODO el historial?')) { closeDeleteMenu(); return; }
            
            const confirmText = prompt('Escribe: BORRAR TODO');
            if (confirmText !== 'BORRAR TODO') { 
                alert('‚ùå Cancelado'); 
                closeDeleteMenu(); 
                return; 
            }

            exportBackup(allData, 'Backup_COMPLETO');

            try {
                await db.ref('lecturas').remove();
                allData = [];
                filteredData = [];
                updateHistoryTable();
                updateCharts();
                alert('‚úÖ Todo borrado.\nüì¶ Backup guardado.');
                closeDeleteMenu();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        function exportBackup(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data.map(item => ({
                ID: item.id,
                Fecha: new Date(item.timestamp).toLocaleString('es-MX'),
                MQ7: item.MQ7,
                MQ135: item.MQ135,
                'PM1.0': item.PM1_0,
                'PM2.5': item.PM2_5,
                PM10: item.PM10,
                Temperatura: item.Temperature,
                Presi√≥n: item.Pressure,
                Altitud: item.Altitude,
                Timestamp: item.timestamp
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Backup');
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Charts
        function initCharts() {
            const ctx1 = document.getElementById('chartCO').getContext('2d');
            charts.CO = new Chart(ctx1, {
                type: 'line',
                data: { labels: [], datasets: [{label: 'CO (ppm)', data: [], borderColor: '#5e5e5e', tension: 0.4}] },
                options: { responsive: true, maintainAspectRatio: true }
            });

            const ctx2 = document.getElementById('chartCO2').getContext('2d');
            charts.CO2 = new Chart(ctx2, {
                type: 'line',
                data: { labels: [], datasets: [{label: 'CO2 (ppm)', data: [], borderColor: '#0088CC', tension: 0.4}] },
                options: { responsive: true, maintainAspectRatio: true }
            });

            const ctx3 = document.getElementById('chartPM').getContext('2d');
            charts.PM = new Chart(ctx3, {
                type: 'line',
                data: { 
                    labels: [], 
                    datasets: [
                        {label: 'PM2.5', data: [], borderColor: '#F59E0B', tension: 0.4},
                        {label: 'PM10', data: [], borderColor: '#EF4444', tension: 0.4}
                    ] 
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            const ctx4 = document.getElementById('chartTemp').getContext('2d');
            charts.Temp = new Chart(ctx4, {
                type: 'line',
                data: { labels: [], datasets: [{label: 'Temperatura (¬∞C)', data: [], borderColor: '#10B981', tension: 0.4}] },
                options: { responsive: true, maintainAspectRatio: true }
            });

            const ctx5 = document.getElementById('chartPressure').getContext('2d');
            charts.Pressure = new Chart(ctx5, {
                type: 'line',
                data: { labels: [], datasets: [{label: 'Presi√≥n (Pa)', data: [], borderColor: '#8B5CF6', tension: 0.4}] },
                options: { responsive: true, maintainAspectRatio: true }
            });
        }

        function setChartRange(range) {
            chartRange = range;
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateCharts();
        }

        function updateCharts() {
            let data = [];
            const now = new Date();

            switch(chartRange) {
                case 'last50':
                    data = filteredData.slice(0, 50);
                    break;
                case 'last100':
                    data = filteredData.slice(0, 100);
                    break;
                case 'hour':
                    const hourAgo = now.getTime() - (60 * 60 * 1000);
                    data = filteredData.filter(d => d.timestamp >= hourAgo);
                    break;
                case 'day':
                    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    data = filteredData.filter(d => d.timestamp >= startOfDay);
                    break;
                case 'week':
                    const weekAgo = now.getTime() - (7 * 24 * 60 * 60 * 1000);
                    data = filteredData.filter(d => d.timestamp >= weekAgo);
                    break;
                case 'all':
                default:
                    data = [...filteredData];
            }

            data = data.reverse(); // Oldest first for charts
            
            // Actualizar contador
            document.getElementById('chartDataCount').textContent = data.length;

            const labels = data.map(d => {
                const date = new Date(d.timestamp);
                if (chartRange === 'last50' || chartRange === 'last100' || chartRange === 'hour') {
                    return date.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
                }
                if (chartRange === 'day') {
                    return date.toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'});
                }
                return date.toLocaleDateString('es-MX', {month: '2-digit', day: '2-digit', hour: '2-digit'});
            });

            // Configuraci√≥n para mejor visualizaci√≥n
            const chartConfig = {
                responsive: true, 
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 15 // Limitar cantidad de labels
                        }
                    },
                    y: {
                        display: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            };

            charts.CO.data.labels = labels;
            charts.CO.data.datasets[0].data = data.map(d => d.MQ7 ? parseFloat(d.MQ7) * 0.005 : 0);
            charts.CO.options = chartConfig;
            charts.CO.update();

            charts.CO2.data.labels = labels;
            charts.CO2.data.datasets[0].data = data.map(d => d.MQ135 ? parseFloat(d.MQ135) * 0.5 : 400);
            charts.CO2.options = chartConfig;
            charts.CO2.update();

            charts.PM.data.labels = labels;
            charts.PM.data.datasets[0].data = data.map(d => parseFloat(d.PM2_5) || 0);
            charts.PM.data.datasets[1].data = data.map(d => parseFloat(d.PM10) || 0);
            charts.PM.options = chartConfig;
            charts.PM.update();

            charts.Temp.data.labels = labels;
            charts.Temp.data.datasets[0].data = data.map(d => parseFloat(d.Temperature) || 0);
            charts.Temp.options = chartConfig;
            charts.Temp.update();

            charts.Pressure.data.labels = labels;
            charts.Pressure.data.datasets[0].data = data.map(d => parseFloat(d.Pressure) || 0);
            charts.Pressure.options = chartConfig;
            charts.Pressure.update();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
